name: FETTI_RIDESHARE_ANALYTICS
description: >
  Production-ready semantic model for Fetti ride-share analytics with comprehensive data quality controls. 
  This model enables natural language queries about trips, riders, popular venues, and user behavior patterns. 
  The dataset includes passenger utilization tracking, data quality flags, and validated demographics for reliable 
  business intelligence and decision-making.

tables:
  - name: dim_address
    description: >
      Address dimension containing Google-standardized addresses for pickup and dropoff locations. 
      Includes popular Austin venues and landmarks with preserved venue names alongside standardized street addresses. 
      Features coordinate validation flags and enhanced deduplication for production reliability.
    synonyms:
      - "addresses"
      - "locations"
      - "places" 
      - "venues"
      - "destinations"
      - "pickup locations"
      - "dropoff locations"
    
    base_table:
      database: FETTI_AI
      schema: CHATAPP
      table: DIM_ADDRESS
    
    primary_key:
      columns:
        - address_id
    
    dimensions:
      - name: address_id
        synonyms:
          - "address id"
          - "location id"
        description: Unique identifier for each address location
        expr: address_id
        data_type: NUMBER(38,0)
        unique: true
      
      - name: address_line
        synonyms:
          - "address"
          - "street address"
          - "location name"
          - "venue name"
          - "place name"
          - "destination name"
        description: Street address or venue name including popular Austin locations and landmarks
        expr: address_line
        data_type: VARCHAR(16777216)
      
      - name: city
        synonyms:
          - "city name"
        description: City name for the address location
        expr: city
        data_type: VARCHAR(16777216)
      
      - name: state
        synonyms:
          - "state name"
          - "state abbreviation"
        description: State abbreviation for the address location
        expr: state
        data_type: VARCHAR(16777216)
      
      - name: country
        synonyms:
          - "country name"
        description: Country name for the address location
        expr: country
        data_type: VARCHAR(16777216)
      
      - name: zipcode
        synonyms:
          - "zip code"
          - "postal code"
        description: Standardized 5-digit ZIP code for the address location
        expr: zipcode
        data_type: VARCHAR(16777216)

      - name: latitude
        synonyms:
          - "lat"
          - "latitude coordinate"
        description: Standardized latitude coordinate for the address location
        expr: latitude
        data_type: NUMBER(38,7)
      
      - name: longitude
        synonyms:
          - "long"
          - "longitude coordinate" 
        description: Standardized longitude coordinate for the address location
        expr: longitude
        data_type: NUMBER(38,7)

      - name: coordinate_valid_flag
        synonyms:
          - "coordinate valid"
          - "valid coordinates"
          - "Austin area flag"
        description: Flag indicating whether coordinates are within valid Austin area boundaries
        expr: coordinate_valid_flag
        data_type: BOOLEAN
    
    filters:
      - name: valid_coordinates_only
        synonyms:
          - "valid locations"
          - "Austin area only"
          - "verified coordinates"
        description: Addresses with coordinates validated as within Austin area boundaries
        expr: coordinate_valid_flag = true

  - name: dim_user
    description: >
      User dimension containing demographic information about ride-share users with comprehensive data quality validation. 
      Includes both riders and bookers with age validation flags, user behavior classifications, and data quality indicators 
      for reliable demographic analysis and customer insights.
    synonyms:
      - "users"
      - "riders"
      - "customers" 
      - "people"
      - "passengers"
      - "bookers"
    
    base_table:
      database: FETTI_AI
      schema: CHATAPP
      table: DIM_USER
    
    primary_key:
      columns:
        - user_id
    
    dimensions:
      - name: user_id
        synonyms:
          - "user id"
          - "customer id" 
          - "rider id"
        description: Unique identifier for each user in the system
        expr: user_id
        data_type: NUMBER(38,0)
        unique: true
      
      - name: age_group
        synonyms:
          - "age bracket"
          - "age range"
          - "age category"
        description: Age group classification for demographic analysis and customer segmentation
        expr: age_group
        data_type: VARCHAR(16777216)
        is_enum: true
        sample_values:
          - "18-25"
          - "26-35"
          - "36-45"
          - "46-55"
          - "56-65"
          - "65+"
          - "Under 18"
          - "Unknown"
      
      - name: user_type
        synonyms:
          - "user category"
          - "customer type"
          - "user role"
        description: Classification based on user behavior - Rider (takes trips), Booker (books trips), or Both
        expr: user_type
        data_type: VARCHAR(16777216)
        is_enum: true
        sample_values:
          - "Rider"
          - "Both"
          - "Booker"
      
      - name: age
        synonyms:
          - "user age"
          - "customer age"
        description: Actual age of the user in years with quality validation applied
        expr: age
        data_type: NUMBER(38,0)

      - name: age_quality_flag
        synonyms:
          - "age quality"
          - "age validation flag"
          - "data quality flag"
        description: Quality indicator for age data - Valid, Missing, Suspicious_Young, or Suspicious_Old
        expr: age_quality_flag
        data_type: VARCHAR(16777216)
        is_enum: true
        sample_values:
          - "Valid"
          - "Missing"
          - "Suspicious_Young" 
          - "Suspicious_Old"
    
    filters:
      - name: valid_ages_only
        synonyms:
          - "valid age data"
          - "reliable ages"
          - "verified ages"
        description: Users with validated age data only, excluding suspicious or missing ages
        expr: age_quality_flag = 'Valid'

      - name: adult_users
        synonyms:
          - "adults"
          - "18 and over"
          - "adult customers"
        description: Users who are adults (18 years and older) with valid age data
        expr: age_quality_flag = 'Valid' AND age >= 18

  - name: fact_trip
    description: >
      Main fact table containing ride-share trip-level data with comprehensive quality controls and utilization metrics. 
      Separates booked passengers from actual riders for accurate capacity analysis, includes data quality flags, 
      time categorization, and weekend indicators for reliable operational insights and business analytics.
    synonyms:
      - "trips"
      - "rides"
      - "journeys"
      - "bookings"
      - "trip data"
    
    base_table:
      database: FETTI_AI
      schema: CHATAPP
      table: FACT_TRIP
    
    primary_key:
      columns:
        - trip_id
    
    dimensions:
      - name: trip_id
        synonyms:
          - "trip id"
          - "ride id"
        description: Unique identifier for each trip in the system
        expr: trip_id
        data_type: NUMBER(38,0)
        unique: true
      
      - name: booking_user_id
        synonyms:
          - "booker id"
          - "booking user"
        description: ID of the user who booked the trip
        expr: booking_user_id
        data_type: NUMBER(38,0)
      
      - name: pickup_address_id
        synonyms:
          - "pickup location id"
          - "start address id"
        description: Address ID for trip pickup location
        expr: pickup_address_id
        data_type: NUMBER(38,0)
      
      - name: dropoff_address_id
        synonyms:
          - "dropoff location id"
          - "destination address id"
          - "end address id"
        description: Address ID for trip dropoff location
        expr: dropoff_address_id
        data_type: NUMBER(38,0)
      
      - name: day_of_week
        synonyms:
          - "day"
          - "weekday"
        description: Day of the week when trip occurred for pattern analysis
        expr: day_of_week
        data_type: VARCHAR(16777216)
        is_enum: true
        sample_values:
          - "Monday"
          - "Tuesday"
          - "Wednesday"
          - "Thursday"
          - "Friday"
          - "Saturday"
          - "Sunday"
      
      - name: hour_of_day
        synonyms:
          - "hour"
          - "time of day"
        description: Hour of day (0-23) when trip started for demand analysis
        expr: hour_of_day
        data_type: NUMBER(38,0)

      - name: time_period
        synonyms:
          - "time of day"
          - "day period"
          - "time category"
        description: Categorized time period for easier analysis - Morning, Afternoon, Evening, or Night
        expr: time_period
        data_type: VARCHAR(16777216)
        is_enum: true
        sample_values:
          - "Morning"
          - "Afternoon" 
          - "Evening"
          - "Night"

      - name: is_weekend
        synonyms:
          - "weekend"
          - "weekend flag"
        description: Boolean flag indicating if trip occurred on weekend (Saturday or Sunday)
        expr: is_weekend
        data_type: BOOLEAN
      
      - name: month
        synonyms:
          - "month number"
        description: Month number (1-12) when trip occurred
        expr: month
        data_type: NUMBER(38,0)
      
      - name: year
        synonyms:
          - "year number"
        description: Year when trip occurred
        expr: year
        data_type: NUMBER(38,0)

      - name: data_quality_flag
        synonyms:
          - "quality flag"
          - "data quality"
          - "trip quality"
        description: Data quality indicator - OK (good data), No_Riders (no actual riders), or Over_Capacity (impossible rider count)
        expr: data_quality_flag
        data_type: VARCHAR(16777216)
        is_enum: true
        sample_values:
          - "OK"
          - "No_Riders"
          - "Over_Capacity"

      - name: passenger_mismatch_flag
        synonyms:
          - "mismatch flag"
          - "passenger mismatch"
        description: Flag indicating if booked passengers count differs from actual riders count
        expr: passenger_mismatch_flag
        data_type: BOOLEAN
      
      - name: pickup_latitude
        synonyms:
          - "pickup lat"
          - "start latitude"
        description: Precise latitude coordinate where trip pickup occurred
        expr: pickup_latitude
        data_type: NUMBER(38,7)
      
      - name: pickup_longitude
        synonyms:
          - "pickup long"
          - "start longitude" 
        description: Precise longitude coordinate where trip pickup occurred
        expr: pickup_longitude
        data_type: NUMBER(38,7)
      
      - name: dropoff_latitude
        synonyms:
          - "dropoff lat"
          - "end latitude"
        description: Precise latitude coordinate where trip dropoff occurred
        expr: dropoff_latitude
        data_type: NUMBER(38,7)
      
      - name: dropoff_longitude
        synonyms:
          - "dropoff long"
          - "end longitude"
        description: Precise longitude coordinate where trip dropoff occurred
        expr: dropoff_longitude
        data_type: NUMBER(38,7)
    
    time_dimensions:
      - name: trip_date
        synonyms:
          - "trip date"
          - "ride date"
          - "date"
        description: Date when the trip occurred for temporal analysis
        expr: trip_date
        data_type: DATE
        unique: false
      
      - name: trip_time
        synonyms:
          - "trip time"
          - "ride time"
          - "start time"
        description: Time when the trip started
        expr: trip_time
        data_type: TIME(9)
        unique: false
    
    facts:
      - name: booked_passengers
        synonyms:
          - "booked passengers"
          - "intended passengers"
          - "booking size"
          - "planned capacity"
        description: Number of passengers originally booked for the trip (intended capacity)
        expr: booked_passengers
        data_type: NUMBER(38,0)
      
      - name: actual_riders_count
        synonyms:
          - "actual riders"
          - "tracked riders"
          - "confirmed riders"
          - "actual passengers"
        description: Number of riders who actually took the trip (validated count from system records)
        expr: actual_riders_count
        data_type: NUMBER(38,0)

      - name: utilization_rate
        synonyms:
          - "utilization"
          - "capacity utilization"
          - "fill rate"
          - "efficiency rate"
        description: Percentage of booked capacity actually utilized (actual riders divided by booked passengers)
        expr: utilization_rate
        data_type: NUMBER(3,2)
    
    metrics:
      - name: total_trips
        synonyms:
          - "trip count"
          - "number of trips"
          - "ride count"
        description: Total number of trips
        expr: COUNT(trip_id)
      
      - name: high_quality_trips
        synonyms:
          - "quality trips"
          - "clean trips"
        description: Total number of trips with good data quality
        expr: COUNT(CASE WHEN data_quality_flag = 'OK' THEN trip_id END)
      
      - name: avg_booked_passengers_per_trip
        synonyms:
          - "average booked"
          - "mean booked passengers"
        description: Average number of booked passengers per trip
        expr: AVG(booked_passengers)
      
      - name: avg_actual_riders_per_trip
        synonyms:
          - "average actual riders"
          - "mean actual riders"
        description: Average number of actual riders per trip
        expr: AVG(actual_riders_count)

      - name: avg_utilization_rate
        synonyms:
          - "average utilization"
          - "mean efficiency"
          - "capacity utilization"
        description: Average utilization rate across all trips
        expr: AVG(utilization_rate)

      - name: weekend_trip_count
        synonyms:
          - "weekend trips"
          - "weekend rides"
        description: Total number of trips on weekends
        expr: COUNT(CASE WHEN is_weekend = true THEN trip_id END)
    
    filters:
      - name: high_quality_trips_only
        synonyms:
          - "quality trips"
          - "clean data"
          - "verified trips"
        description: Trips with good data quality (no data quality issues or passenger mismatches)
        expr: data_quality_flag = 'OK' AND passenger_mismatch_flag = false
      
      - name: weekend_trips
        synonyms:
          - "weekend"
          - "weekend rides"
        description: Trips that occurred on weekends (Saturday or Sunday)
        expr: is_weekend = true
      
      - name: weekday_trips
        synonyms:
          - "weekday"
          - "business days"
        description: Trips that occurred on weekdays (Monday through Friday)
        expr: is_weekend = false

      - name: high_utilization_trips
        synonyms:
          - "efficient trips"
          - "high utilization"
          - "full capacity"
        description: Trips with utilization rate above 80% (highly efficient trips)
        expr: utilization_rate > 0.80

      - name: morning_trips
        synonyms:
          - "morning"
          - "morning rides"
        description: Trips that occurred in the morning (5 AM to 12 PM)
        expr: time_period = 'Morning'

      - name: evening_trips
        synonyms:
          - "evening"
          - "evening rides"
        description: Trips that occurred in the evening (5 PM to 9 PM)
        expr: time_period = 'Evening'

  - name: fact_trip_riders
    description: >
      Bridge table capturing the many-to-many relationship between trips and riders with referential integrity validation. 
      Links individual riders to shared trips, enabling detailed analysis of rider participation patterns, group ride behavior, 
      and trip sharing dynamics with data quality assurance.
    synonyms:
      - "trip riders"
      - "rider trips"
      - "trip participants"
      - "passengers per trip"
      - "ride sharing"
    
    base_table:
      database: FETTI_AI
      schema: CHATAPP
      table: FACT_TRIP_RIDERS
    
    primary_key:
      columns:
        - trip_id
        - rider_user_id
    
    dimensions:
      - name: trip_id
        synonyms:
          - "trip id"
          - "ride id"
        description: Trip identifier linking to the main trip fact table
        expr: trip_id
        data_type: NUMBER(38,0)
      
      - name: rider_user_id
        synonyms:
          - "rider id"
          - "participant id"
        description: User ID of the trip participant (the person who took the ride)
        expr: rider_user_id
        data_type: NUMBER(38,0)
    
    metrics:
      - name: total_trip_participations
        synonyms:
          - "total participations"
          - "rider trip count"
        description: Total number of trip participations (each rider-trip combination)
        expr: COUNT(*)
      
      - name: unique_riders
        synonyms:
          - "distinct riders"
          - "number of unique riders"
        description: Count of unique riders across all trips
        expr: COUNT(DISTINCT rider_user_id)

      - name: unique_trips_with_riders
        synonyms:
          - "trips with riders"
          - "active trips"
        description: Count of unique trips that had at least one rider
        expr: COUNT(DISTINCT trip_id)

relationships:
  - name: trip_to_pickup_address
    left_table: fact_trip
    right_table: dim_address
    relationship_columns:
      - left_column: pickup_address_id
        right_column: address_id
    join_type: left_outer
    relationship_type: many_to_one

  - name: trip_to_dropoff_address
    left_table: fact_trip
    right_table: dim_address
    relationship_columns:
      - left_column: dropoff_address_id
        right_column: address_id
    join_type: left_outer
    relationship_type: many_to_one

  - name: trip_to_booking_user
    left_table: fact_trip
    right_table: dim_user
    relationship_columns:
      - left_column: booking_user_id
        right_column: user_id
    join_type: left_outer
    relationship_type: many_to_one

  - name: trip_riders_to_trip
    left_table: fact_trip_riders
    right_table: fact_trip
    relationship_columns:
      - left_column: trip_id
        right_column: trip_id
    join_type: inner
    relationship_type: many_to_one

  - name: trip_riders_to_user
    left_table: fact_trip_riders
    right_table: dim_user
    relationship_columns:
      - left_column: rider_user_id
        right_column: user_id
    join_type: left_outer
    relationship_type: many_to_one

verified_queries:
  - name: "High quality trips by day of week"
    question: "How many high-quality trips happened on each day of the week?"
    verified_by: "Data Analyst"
    use_as_onboarding_question: true
    sql: |
      SELECT 
        day_of_week,
        COUNT(CASE WHEN data_quality_flag = 'OK' THEN trip_id END) as high_quality_trips,
        COUNT(trip_id) as total_trips,
        ROUND(COUNT(CASE WHEN data_quality_flag = 'OK' THEN trip_id END) * 100.0 / COUNT(trip_id), 2) as quality_percentage
      FROM fact_trip
      GROUP BY day_of_week
      ORDER BY high_quality_trips DESC

  - name: "Utilization rates by time period"
    question: "What are the average utilization rates by time of day?"
    verified_by: "Data Analyst"
    use_as_onboarding_question: true
    sql: |
      SELECT 
        time_period,
        ROUND(AVG(utilization_rate) * 100, 2) as avg_utilization_percentage,
        COUNT(trip_id) as trip_count,
        ROUND(AVG(booked_passengers), 2) as avg_booked,
        ROUND(AVG(actual_riders_count), 2) as avg_actual
      FROM fact_trip
      WHERE data_quality_flag = 'OK'
      GROUP BY time_period
      ORDER BY avg_utilization_percentage DESC

  - name: "Valid user demographics by age group"
    question: "What is the distribution of users by age group excluding suspicious ages?"
    verified_by: "Data Analyst"
    use_as_onboarding_question: true
    sql: |
      SELECT 
        u.age_group,
        COUNT(*) as user_count,
        ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
      FROM dim_user u
      WHERE u.age_quality_flag = 'Valid'
      GROUP BY u.age_group
      ORDER BY user_count DESC

  - name: "Most popular pickup locations with valid coordinates"
    question: "What are the top 10 most popular pickup locations with valid coordinates?"
    verified_by: "Data Analyst"
    use_as_onboarding_question: true
    sql: |
      SELECT 
        a.address_line,
        a.city,
        a.zipcode,
        COUNT(f.trip_id) as trip_count,
        ROUND(AVG(f.utilization_rate) * 100, 2) as avg_utilization_pct
      FROM fact_trip f
      JOIN dim_address a ON f.pickup_address_id = a.address_id
      WHERE a.coordinate_valid_flag = true 
        AND f.data_quality_flag = 'OK'
      GROUP BY a.address_line, a.city, a.zipcode
      ORDER BY trip_count DESC
      LIMIT 10

  - name: "Weekend vs weekday utilization comparison"
    question: "How do utilization rates compare between weekends and weekdays?"
    verified_by: "Data Analyst"
    use_as_onboarding_question: true
    sql: |
      SELECT 
        CASE WHEN is_weekend = true THEN 'Weekend' ELSE 'Weekday' END as day_type,
        COUNT(trip_id) as total_trips,
        ROUND(AVG(utilization_rate) * 100, 2) as avg_utilization_pct,
        ROUND(AVG(booked_passengers), 2) as avg_booked,
        ROUND(AVG(actual_riders_count), 2) as avg_actual,
        COUNT(CASE WHEN utilization_rate > 0.80 THEN 1 END) as high_utilization_trips
      FROM fact_trip
      WHERE data_quality_flag = 'OK'
      GROUP BY is_weekend
      ORDER BY avg_utilization_pct DESC

  - name: "Rider engagement by validated user type"
    question: "How many trips do different user types take on average using validated data only?"
    verified_by: "Data Analyst"
    use_as_onboarding_question: false
    sql: |
      SELECT 
        u.user_type,
        COUNT(tr.trip_id) as total_participations,
        COUNT(DISTINCT tr.rider_user_id) as unique_riders,
        ROUND(COUNT(tr.trip_id) * 1.0 / COUNT(DISTINCT tr.rider_user_id), 2) as avg_trips_per_rider,
        COUNT(CASE WHEN f.data_quality_flag = 'OK' THEN tr.trip_id END) as quality_participations
      FROM fact_trip_riders tr
      JOIN dim_user u ON tr.rider_user_id = u.user_id
      JOIN fact_trip f ON tr.trip_id = f.trip_id
      WHERE u.age_quality_flag = 'Valid'
      GROUP BY u.user_type
      ORDER BY avg_trips_per_rider DESC
